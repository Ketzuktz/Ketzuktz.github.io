# 七圣召唤效果描述语言

## 1.目标 `target`

绝大多数效果都有特定的目标承受其效果，包括攻击的伤害 (damage), 治疗 (heal)，元素附着 (elemental application) 等。

通常目标分为以下几类：

1. 出战角色
2. 选定角色（玩家选择）
3. 所有角色
4. 所有后台角色
5. 出战角色的前一个角色
6. 出战角色的后一个角色

特别的，考虑到可扩展性，加入`出战角色的前 n 个角色`和`出战角色的后 n 个角色`两类。

*这里我们姑且不考虑 `当前出战角色和后一个角色` 这种情况*

因此，target 可以设计为以下结构：

```xml
<side> ::= 'self' | 'enemy'
<transition_type> ::= 'prev' | 'next'
<transition> ::= <transition_type> [ '(' <number> ')' ]
<selector> ::= <transition> | 'active' | 'select' | 'all' | 'backend'

<target> = <side> '.' <selector>
```

## 2.伤害 `damage`

每个伤害，构成要素包括，伤害来源、伤害目标、伤害属性。

- [ ] 伤害来源：在伤害开始计算时获取，此处先不做考虑；
- [x] 伤害目标：参考 [目标](#1目标-target) 设计；
- [x] 伤害属性：包括伤害类型：如伤害来自扩散、直接伤害或是召唤物伤害等，与伤害值（单个数值）。

伤害属性可以分为以下几类：

1. 伤害来源类型：
   - 普通攻击
   - 元素战技
   - 元素爆发
   - 召唤物
   - 元素反应
2. 伤害元素类型：
   - 物理攻击
   - 七种元素
   - 穿透伤害
3. 伤害值：单个数值

```xml
<damage_src_type> ::= 'normal_attack' | ...
<damage_element> ::= 'physical' | ...
<damage_func> ::= 'damage.' <damage_src_type> '.' <damage_element>

<damage> := <damage_func> '(' <target> ',' <number> ')'
```

## 3.治疗 `heal`

治疗基本与伤害一致，只是不含来源类型属性与元素属性。

```xml
<heal_func> ::= 'heal'

<heal> = <heal_func> '(' <target> ',' <number> ')'
```

## 4.切人 `switch`

切人分为快速行动和普通行动，根据目标的敌我来确定切换敌方还是我方的角色。

```xml
<switch_suffix> ::= '.fast'
<switch_func> ::= 'switch' [ <switch_suffix> ]

<switch> ::= <switch_func> '(' <target> ')'
```

## 5.计数器 `counter`

很多操作都与计数器相关，包括每回合一次、每回合三次、整局游戏一次等。

对于部分卡牌，需要注册计数器，影响所有操作，另一些则影响较小。

### 5.1 域计数器 `(local) counter`

单个角色、技能、卡牌创建自己的计数器，用于限制生效次数或随着使用增加强度。

计数器的使用包括计数器初始化（整局初始化或回合初始化）、计数器更新、计数器检查三个部分。

1. 计数器初始化包括什么时候初始化、初始化为什么值，这两个信息；
2. 计数器更新包括更新的变化量是多少；
3. 计数器检查为效果生效条件。

计数器初始化：

```xml
<counter_name> ::= <quoted_string>
<counter_init_func> ::= 'counter.init'

<counter_init> ::= <counter_init_func> '(' <counter_name> ',' <phase_name> ',' <init_value> ')'
```

计数器更新：

```xml
<counter_update> ::= <counter_update_func> '(' <counter_name> ',' <phase_name> ',' <update_value_delta> ')'
```

计数器检查：

```xml
<cmp_func> ::= 'le' | 'ge' | 'lt' | 'gt' | 'eq' | 'ne'
<counter_check_func> ::= 'counter.if.' <cmp_func>
<counter_check> ::= <counter_check_func> '(' <counter_name> ',' <value> ')'
```

### 6.元素附着 Elemental Application
