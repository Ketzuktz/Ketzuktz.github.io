# 七圣召唤效果描述语言

## 1.机制

玩家进行操作 `PlayerOperation`，该操作会映射到一个 `Mutation`，表示该操作带来的影响；

每个 `Mutation` 包含若干 `Event`，用来描述该操作的效果。

不妨举个复杂的例子：

> 敌方出战角色挂冰，后台角色挂雷，万叶开 E 对出战角色造成 3 点风伤害并扩散冰，将对后台角色造成一点冰元素伤害，但冰雷反应超导，所以本次冰元素 + 1，并对出战角色造成 1 点穿透伤害。
>
> 该流程中伤害共三次，分别是对出战角色的 3 点风伤害，对后台角色的两点冰伤害和对出战角色的 1 点穿透伤害。

这一系列伤害均来自 *玩家操作 - 元素战技*，其中包含三个 `Event`，分别是元素战技伤害结算、扩散伤害结算与超导伤害结算。

更具体的，流程如下：

> - 玩家使用元素战技 # Mutation
>   - Event 1
>     - 元素战技效果：对敌方出战角色造成 3 点风伤害
>     - 准备对敌方出战角色造成 3 点风伤害
>     - 风冰元素反应，**准备对（出战角色的）其他角色造成 1 点冰伤害**
>     - 结算对出战角色的 3 点风伤害
>   - Event 2
>     - **准备对（出战角色的）其他角色造成 1 点冰伤害**
>     - 冰雷元素反应，本次伤害 +1，**准备对（后台角色的）其他角色造成 1 点穿透伤害**
>     - 结算对后台角色的 2 点冰伤害
>   - Event 3
>     - **准备对（后台角色的）其他角色造成 1 点穿透伤害**
>     - 结算对出战角色的 1 点穿透伤害

可以看到，这里的三个 `Event` 都是以伤害事件为主体，`Event` 还可以包含其他类型，如切换角色等。

除了 `Mutation` 和 `Event`，再引入概念 `Effect`，指特殊效果，如 `万叶使用元素战技后切换到下一个角色`，这里的 `切换到下一个角色`，就是万叶元素战技附带的 `Effect`。

部分 `Effect` 不是即时生效的，如迪卢克的元素战技 `本回合第三次使用元素战技时，伤害 +2` ，也即是说，这在暗示该效果携带一个计数器，对于该例子，首先需要全局注册该效果，随后，每回合开始时清空该计数器，并在每次发动时候累计计数器。

那么在此基础上，一个关键点在于，对已有的 `Effect` 进行归纳整理，并保留可扩展性。


## 2.规则

### 1.目标 `target`

绝大多数效果都有特定的目标承受其效果，包括攻击的伤害 (damage), 治疗 (heal)，元素附着 (elemental application) 等。

通常目标分为以下几类：

1. 出战角色
2. 选定角色（玩家选择）
3. 所有角色
4. 所有后台角色
5. 出战角色的前一个角色
6. 出战角色的后一个角色

特别的，考虑到可扩展性，加入`出战角色的前 n 个角色`和`出战角色的后 n 个角色`两类。

*这里我们姑且不考虑 `当前出战角色和后一个角色` 这种情况*

因此，target 可以设计为以下结构：

```xml
<side> ::= 'self' | 'enemy'
<transition_type> ::= 'prev' | 'next'
<transition> ::= <transition_type> [ '(' <number> ')' ]
<selector> ::= <transition> | 'active' | 'select' | 'all' | 'backend'

<target> = <side> '.' <selector>
```

### 2.伤害 `damage`

每个伤害，构成要素包括，伤害来源、伤害目标、伤害属性。

- [ ] 伤害来源：在伤害开始计算时获取，此处先不做考虑；
- [x] 伤害目标：参考 [目标](#1目标-target) 设计；
- [x] 伤害属性：包括伤害类型：如伤害来自扩散、直接伤害或是召唤物伤害等，与伤害值（单个数值）。

伤害属性可以分为以下几类：

1. 伤害来源类型：
   - 普通攻击
   - 元素战技
   - 元素爆发
   - 召唤物
   - 元素反应
2. 伤害元素类型：
   - 物理攻击
   - 七种元素
   - 穿透伤害
3. 伤害值：单个数值

```xml
<damage_src_type> ::= 'normal_attack' | ...
<damage_element> ::= 'physical' | ...
<damage_func> ::= 'damage.' <damage_src_type> '.' <damage_element>

<damage> := <damage_func> '(' <target> ',' <number> ')'
```

### 3.治疗 `heal`

治疗基本与伤害一致，只是不含来源类型属性与元素属性。

```xml
<heal_func> ::= 'heal'

<heal> = <heal_func> '(' <target> ',' <number> ')'
```

### 4.切人 `switch`

切人分为快速行动和普通行动，根据目标的敌我来确定切换敌方还是我方的角色。

```xml
<switch_suffix> ::= '.fast'
<switch_func> ::= 'switch' [ <switch_suffix> ]

<switch> ::= <switch_func> '(' <target> ')'
```

### 5.计数器 `counter`

很多操作都与计数器相关，包括每回合一次、每回合三次、整局游戏一次等。

对于部分卡牌，需要注册计数器，影响所有操作，另一些则影响较小。

#### 5.1 域计数器 `(local) counter`

单个角色、技能、卡牌创建自己的计数器，用于限制生效次数或随着使用增加强度。

计数器的使用包括计数器初始化（整局初始化或回合初始化）、计数器更新、计数器检查三个部分。

1. 计数器初始化包括什么时候初始化、初始化为什么值，这两个信息；
2. 计数器更新包括更新的变化量是多少；
3. 计数器检查为效果生效条件。

计数器初始化：

```xml
<counter_name> ::= <quoted_string>
<counter_init_func> ::= 'counter.init'

<counter_init> ::= <counter_init_func> '(' <counter_name> ',' <phase_name> ',' <init_value> ')'
```

计数器更新：

```xml
<counter_update> ::= <counter_update_func> '(' <counter_name> ',' <phase_name> ',' <update_value_delta> ')'
```

计数器检查：

```xml
<cmp_func> ::= 'le' | 'ge' | 'lt' | 'gt' | 'eq' | 'ne'
<counter_check_func> ::= 'counter.if.' <cmp_func>
<counter_check> ::= <counter_check_func> '(' <counter_name> ',' <value> ')'
```

### 6.元素附着 Elemental Application

这里特指无伤害的元素附着，规则同伤害。

### 7.效果注册

任何效果需要进行注册，标明该效果的来源等。

***TODO***

### 8.Buff

Buff：特定角色或特定阵营生效的效果。

计数器通常是 Buff。
